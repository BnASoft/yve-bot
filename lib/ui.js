!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("./core")):"function"==typeof define&&define.amd?define(["./core"],t):e.YveBot=t(e.YveBot)}(this,function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};var n=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};function i(e){return[].slice.call(e)}var o=function(){function e(e){this.options=e,this.chat=this.createChat(),this.typing=this.createTyping(),this.conversation=this.createConversation(),this.textArea=this.createTextarea(),this.inputText=this.createInput(),this.input=this.textArea,this.submit=this.createSubmit(),this.form=this.createForm(this.input,this.submit),this.conversation.appendChild(this.typing),this.chat.appendChild(this.conversation),this.chat.appendChild(this.form),this.pressedKeys=[],this.chat.addEventListener("keydown",this.handleKey.bind(this),!1),this.chat.addEventListener("keyup",this.handleKey.bind(this),!1)}return e.prototype.createSingleChoiceMessage=function(e,t){var n=this;return e.options.length?(this.disableForm(this.options.inputPlaceholderSingleChoice),this.createBubbleMessage(e,function(e,i){i.remove(),n.enableForm(),t(e.getAttribute("data-label"),e.getAttribute("data-value"))})):document.createElement("div")},e.prototype.createBubbleButton=function(e,t,n){var i=this,o=document.createElement("button");o.className="yvebot-message-bubbleBtn",n&&n.class&&o.classList.add(n.class),o.onclick=function(){t(o),i.scrollDown(0,!0)};var r=e.value,a=e.label;return o.setAttribute("data-value",String((void 0===r?a:r)||"")),o.setAttribute("data-label",String((void 0===a?r:a)||"")),o.textContent=o.getAttribute("data-label"),o},e.prototype.disableForm=function(e){this.submit.disabled=!0,this.input.disabled=!0,this.input.placeholder=e},e.prototype.enableForm=function(){this.submit.disabled=!1,this.input.disabled=!1,this.input.placeholder=this.options.inputPlaceholder,this.options.autoFocus&&this.input.focus()},e.prototype.createBubbleMessage=function(e,t){var n=this,i=e.maxOptions,o=void 0===i?0:i,r=this.options.moreOptionsLabel,a=document.createElement("div");a.className="yvebot-message-bubbles yvebot-ruleType-"+e.type;var s=function(e,i){void 0===i&&(i=0);var c=o?i+o-1:e.length;e.slice(i,c).forEach(function(i,l){var p=n.createBubbleButton(i,function(e){return t(e,a)});if(a.appendChild(p),c<e.length&&l===o-2){var u=n.createBubbleButton({label:r},function(){s(e,c),u.remove()},{class:"yvebot-message-bubbleMoreOptions"});a.appendChild(u)}})};return s(e.options),a},e.prototype.createMultipleChoiceMessage=function(e,t){var n=document.createElement("div");if(e.options.length){var o=document.createElement("button");o.textContent=this.options.doneMultipleChoiceLabel,o.className="yvebot-message-bubbleDone",o.style.display="none";var r=this;o.onclick=function(){var e=this.previousElementSibling,n=e.querySelectorAll(".yvebot-message-bubbleBtn.selected"),a=i(n).map(function(e){return e.getAttribute("data-label")}),s=i(n).map(function(e){return e.getAttribute("data-value")});t(a,s),e.remove(),o.remove(),r.enableForm()};var a=this.createBubbleMessage(e,function(e){e.classList.toggle("selected"),a.querySelectorAll(".yvebot-message-bubbleBtn.selected").length?o.style.display="inline-block":o.style.display="none"});this.disableForm(this.options.inputPlaceholderMutipleChoice),n.appendChild(a),n.appendChild(o)}return n},e.prototype.createChat=function(){var e=document.createElement("div");return e.className="yvebot-chat",e},e.prototype.createConversation=function(){var e=document.createElement("ul");return e.className="yvebot-conversation",e},e.prototype.createTyping=function(){var e=document.createElement("div");return e.className="yvebot-typing",[1,2,3].forEach(function(){var t=document.createElement("span");t.className="yvebot-typing-dot",e.appendChild(t)}),this.createThread("BOT",e,"yvebot-thread-typing")},e.prototype.createForm=function(e,t){var n=document.createElement("form");return n.className="yvebot-form",n.appendChild(e),n.appendChild(t),n},e.prototype.createSubmit=function(){var e=document.createElement("button");return e.className="yvebot-form-submit",e.type="submit",e.textContent=this.options.submitLabel,e},e.prototype.createInput=function(){var e=document.createElement("input");return e.className="yvebot-form-input",e.type="text",e.placeholder=this.options.inputPlaceholder,e.autocomplete="off",e},e.prototype.createTextarea=function(){var e=document.createElement("textarea");return e.className="yvebot-form-input",e.placeholder=this.options.inputPlaceholder,e},e.prototype.createThread=function(e,t,n){var i=document.createElement("li");return i.className="yvebot-thread yvebot-thread-"+e.toLowerCase(),n&&i.classList.add(n),i.appendChild(t),i},e.prototype.replaceWithInputText=function(){this.form.replaceChild(this.inputText,this.input),this.input=this.inputText},e.prototype.replaceWithTextArea=function(){this.form.replaceChild(this.textArea,this.input),this.input=this.textArea},e.prototype.appendThread=function(e,t,n){t.insertBefore(n,this.typing),this.scrollDown(n.offsetHeight,"USER"===e)},e.prototype.scrollDown=function(e,t){void 0===t&&(t=!1);(this.conversation.scrollHeight-this.conversation.scrollTop-this.conversation.offsetHeight-20<=e||t)&&(this.conversation.scrollTop=this.conversation.scrollHeight)},e.prototype.createTextMessage=function(e,t){var n,i,o,r,a,s=this.options,c=s.timestampable,l=s.timestampFormatter;if(e instanceof Array){var p=e.map(String);i=p,o=this.options.andSeparatorText,r=i.slice(0,-1).join(", "),a=i.slice(-1),n=1===i.length?i[0]:r+" "+o+" "+a}else n=String(e);var u=document.createElement("div");if(u.className="yvebot-bubble",t){var h=document.createElement("div");h.className="yvebot-sender",h.innerHTML=t,u.appendChild(h)}var d=document.createElement("div");if(d.className="yvebot-message",d.innerHTML=n,u.appendChild(d),c){var m=document.createElement("div");m.className="yvebot-timestamp",m.innerHTML=l(Date.now()),u.appendChild(m)}return u},e.prototype.handleKey=function(e){var t=e.keyCode,n=e.type;if(this.pressedKeys[t]="keydown"===n,!this.pressedKeys[16]&&this.pressedKeys[13]){var i=new Event("submit");this.form.dispatchEvent(i)}},e}();return function(e){function i(t,i){var r=this,a=n({},{andSeparatorText:"and",autoFocus:!0,doneMultipleChoiceLabel:"Done",inputPlaceholder:"Type your message",inputPlaceholderMutipleChoice:"Choose the options above",inputPlaceholderSingleChoice:"Choose an option above",moreOptionsLabel:"More options",submitLabel:"Send",target:"body",timestampFormatter:function(e){return new Date(e).toUTCString().slice(-12,-4)},timestampable:!1},i);return(r=e.call(this,t,a.yveBotOptions)||this).UIOptions=a,r.UI=new o(r.UIOptions),r.on("start",function(){(document.querySelector(r.UIOptions.target).appendChild(r.UI.chat),r.UIOptions.autoFocus)&&r.UI.input.focus()}).on("talk",function(e,t){r.newMessage("BOT",e,t)}).on("hear",function(e){return r.hearing(e)}).on("listen",function(e,t){return r.listening(t)}).on("typing",function(){return r.typing()}).on("typed",function(){return r.typed()}),r.UI.form.addEventListener("submit",function(e){e.preventDefault();var t=r.UI.input,n=t.value.trim();n&&(r.hear(n),r.newMessage("USER",n),t.value=""),r.UIOptions.autoFocus&&t.focus()}),r}return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}(i,e),i.prototype.typing=function(){return this.UI.typing.classList.add("is-typing"),this.UI.scrollDown(this.UI.typing.offsetHeight),this},i.prototype.typed=function(){return this.UI.typing.classList.remove("is-typing"),this.UI.scrollDown(this.UI.typing.offsetHeight),this},i.prototype.hearing=function(e){return e.multline||this.UI.replaceWithInputText(),this},i.prototype.listening=function(e){return e.multline||this.UI.replaceWithTextArea(),this},i.prototype.newMessage=function(e,t,n){var i=this,o=this.UI,r="BOT"===e?this.UIOptions.name:null,a=o.createThread(e,o.createTextMessage(t,r));if("BOT"===e)switch(n.type){case"SingleChoice":a.appendChild(o.createSingleChoiceMessage(n,function(e,t){i.hear(t),i.newMessage("USER",e)}));break;case"MultipleChoice":a.appendChild(o.createMultipleChoiceMessage(n,function(e,t){i.hear(t),i.newMessage("USER",e)}))}return o.appendThread(e,this.UI.conversation,a),this},i}(e)});
