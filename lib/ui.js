!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("./core")):"function"==typeof define&&define.amd?define(["./core"],e):t.YveBot=e(t.YveBot)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};var n=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t};function i(t){return[].slice.call(t)}var o=function(){function t(t){this.options=t,this.chat=this.createChat(),this.typing=this.createTyping(),this.conversation=this.createConversation(),this.textArea=this.createTextarea(),this.inputText=this.createInput(),this.input=this.textArea,this.submit=this.createSubmit(),this.form=this.createForm(this.input,this.submit),this.conversation.appendChild(this.typing),this.chat.appendChild(this.conversation),this.chat.appendChild(this.form),this.pressedKeys=[],this.chat.addEventListener("keydown",this.handleKey.bind(this),!1),this.chat.addEventListener("keyup",this.handleKey.bind(this),!1)}return t.prototype.createSingleChoiceMessage=function(t,e){var n=this;return t.options.length?(this.disableForm(this.options.inputPlaceholderSingleChoice),this.createBubbleMessage(t,function(t,i){i.remove(),n.enableForm(),e(t.getAttribute("data-label"),t.getAttribute("data-value"))})):document.createElement("div")},t.prototype.createBubbleButton=function(t,e,n){var i=this,o=document.createElement("button");o.className="yvebot-message-bubbleBtn",n&&n.class&&o.classList.add(n.class),o.onclick=function(){e(o),i.scrollDown(0,!0)};var s=t.value,r=t.label;return o.setAttribute("data-value",String((void 0===s?r:s)||"")),o.setAttribute("data-label",String((void 0===r?s:r)||"")),o.textContent=o.getAttribute("data-label"),o},t.prototype.disableForm=function(t){this.submit.disabled=!0,this.input.disabled=!0,this.input.placeholder=t},t.prototype.enableForm=function(){this.submit.disabled=!1,this.input.disabled=!1,this.input.placeholder=this.options.inputPlaceholder,this.options.autoFocus&&this.input.focus()},t.prototype.createBubbleMessage=function(t,e){var n=this,i=t.maxOptions,o=void 0===i?0:i,s=this.options.moreOptionsLabel,r=document.createElement("div");r.className="yvebot-message-bubbles yvebot-ruleType-"+t.type;var a=function(t,i){void 0===i&&(i=0);var c=o?i+o-1:t.length;t.slice(i,c).forEach(function(i,p){var l=n.createBubbleButton(i,function(t){return e(t,r)});if(r.appendChild(l),c<t.length&&p===o-2){var u=n.createBubbleButton({label:s},function(){a(t,c),u.remove()},{class:"yvebot-message-bubbleMoreOptions"});r.appendChild(u)}})};return a(t.options),r},t.prototype.createMultipleChoiceMessage=function(t,e){var n=document.createElement("div");if(t.options.length){var o=document.createElement("button");o.textContent=this.options.doneMultipleChoiceLabel,o.className="yvebot-message-bubbleDone",o.style.display="none";var s=this;o.onclick=function(){var t=this.previousElementSibling,n=t.querySelectorAll(".yvebot-message-bubbleBtn.selected"),r=i(n).map(function(t){return t.getAttribute("data-label")}),a=i(n).map(function(t){return t.getAttribute("data-value")});e(r,a),t.remove(),o.remove(),s.enableForm()};var r=this.createBubbleMessage(t,function(t){t.classList.toggle("selected"),r.querySelectorAll(".yvebot-message-bubbleBtn.selected").length?o.style.display="inline-block":o.style.display="none"});this.disableForm(this.options.inputPlaceholderMutipleChoice),n.appendChild(r),n.appendChild(o)}return n},t.prototype.createChat=function(){var t=document.createElement("div");return t.className="yvebot-chat",t},t.prototype.createConversation=function(){var t=document.createElement("ul");return t.className="yvebot-conversation",t},t.prototype.createTyping=function(){var t=document.createElement("div");return t.className="yvebot-typing",[1,2,3].forEach(function(){var e=document.createElement("span");e.className="yvebot-typing-dot",t.appendChild(e)}),this.createThread("BOT",t,"yvebot-thread-typing")},t.prototype.createForm=function(t,e){var n=document.createElement("form");return n.className="yvebot-form",n.appendChild(t),n.appendChild(e),n},t.prototype.createSubmit=function(){var t=document.createElement("button");return t.className="yvebot-form-submit",t.type="submit",t.textContent=this.options.submitLabel,t},t.prototype.createInput=function(){var t=document.createElement("input");return t.className="yvebot-form-input",t.type="text",t.placeholder=this.options.inputPlaceholder,t.autocomplete="off",t},t.prototype.createTextarea=function(){var t=document.createElement("textarea");return t.className="yvebot-form-input",t.rows=1,t.placeholder=this.options.inputPlaceholder,t},t.prototype.createThread=function(t,e,n){var i=document.createElement("li");return i.className="yvebot-thread yvebot-thread-"+t.toLowerCase(),n&&i.classList.add(n),i.appendChild(e),i},t.prototype.replaceWithInputText=function(){this.form.replaceChild(this.inputText,this.input),this.input=this.inputText},t.prototype.replaceWithTextArea=function(){this.form.replaceChild(this.textArea,this.input),this.input=this.textArea},t.prototype.appendThread=function(t,e,n){e.insertBefore(n,this.typing),this.scrollDown(n.offsetHeight,"USER"===t)},t.prototype.scrollDown=function(t,e){void 0===e&&(e=!1);(this.conversation.scrollHeight-this.conversation.scrollTop-this.conversation.offsetHeight-20<=t||e)&&(this.conversation.scrollTop=this.conversation.scrollHeight)},t.prototype.createTextMessage=function(t,e){var n,i,o,s,r,a=this.options,c=a.timestampable,p=a.timestampFormatter;if(t instanceof Array){var l=t.map(String);i=l,o=this.options.andSeparatorText,s=i.slice(0,-1).join(", "),r=i.slice(-1),n=1===i.length?i[0]:s+" "+o+" "+r}else n=String(t);var u=document.createElement("div");if(u.className="yvebot-bubble",e){var h=document.createElement("div");h.className="yvebot-sender",h.innerHTML=e,u.appendChild(h)}var d=document.createElement("div");if(d.className="yvebot-message",d.innerHTML=n,u.appendChild(d),c){var m=document.createElement("div");m.className="yvebot-timestamp",m.innerHTML=p(Date.now()),u.appendChild(m)}return u},t.prototype.handleKey=function(t){var e=t.keyCode,n=t.type;this.pressedKeys[e]="keydown"===n;var i=+this.input.getAttribute("rows");if(this.pressedKeys[16]&&this.pressedKeys[13]&&"textarea"===this.input.type)this.input.setAttribute("rows",String(i+1));else if(this.pressedKeys[8]&&1!==i&&"textarea"===this.input.type){var o=this.input.value.split("\n");o[o.length-1]||this.input.setAttribute("rows",String(i-1))}else if(!this.pressedKeys[16]&&this.pressedKeys[13]){var s=new Event("submit");this.form.dispatchEvent(s)}},t}();return function(t){function i(e,i){var s=this,r=n({},{andSeparatorText:"and",autoFocus:!0,doneMultipleChoiceLabel:"Done",inputPlaceholder:"Type your message",inputPlaceholderMutipleChoice:"Choose the options above",inputPlaceholderSingleChoice:"Choose an option above",moreOptionsLabel:"More options",submitLabel:"Send",target:"body",timestampFormatter:function(t){return new Date(t).toUTCString().slice(-12,-4)},timestampable:!1},i);return(s=t.call(this,e,r.yveBotOptions)||this).UIOptions=r,s.UI=new o(s.UIOptions),s.on("start",function(){(document.querySelector(s.UIOptions.target).appendChild(s.UI.chat),s.UIOptions.autoFocus)&&s.UI.input.focus()}).on("talk",function(t,e){s.newMessage("BOT",t,e)}).on("hear",function(t){return s.hearing(t)}).on("listen",function(t,e){return s.listening(e)}).on("typing",function(){return s.typing()}).on("typed",function(){return s.typed()}),s.UI.form.addEventListener("submit",function(t){t.preventDefault();var e=s.UI.input,n=e.value.trim();n&&(s.hear(n),s.newMessage("USER",n),e.value=""),s.UIOptions.autoFocus&&e.focus()}),s}return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}(i,t),i.prototype.typing=function(){return this.UI.typing.classList.add("is-typing"),this.UI.scrollDown(this.UI.typing.offsetHeight),this},i.prototype.typed=function(){return this.UI.typing.classList.remove("is-typing"),this.UI.scrollDown(this.UI.typing.offsetHeight),this},i.prototype.hearing=function(t){return t.multline||this.UI.replaceWithInputText(),this},i.prototype.listening=function(t){return t.multline||this.UI.replaceWithTextArea(),this},i.prototype.newMessage=function(t,e,n){var i=this,o=this.UI,s="BOT"===t?this.UIOptions.name:null,r=o.createThread(t,o.createTextMessage(e,s));if("BOT"===t)switch(n.type){case"SingleChoice":r.appendChild(o.createSingleChoiceMessage(n,function(t,e){i.hear(e),i.newMessage("USER",t)}));break;case"MultipleChoice":r.appendChild(o.createMultipleChoiceMessage(n,function(t,e){i.hear(e),i.newMessage("USER",t)}))}return o.appendThread(t,this.UI.conversation,r),this},i}(t)});
